<!DOCTYPE html>
<html lang="it" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì FdP AutoCorrezione - UniPi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .progress-bar {
            animation: progress 30s ease-in-out;
        }

        .markdown-content h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 0.75em;
            margin-bottom: 0.5em;
        }
        .markdown-content ul {
            list-style: disc;
            margin-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .markdown-content li {
            margin-bottom: 0.25em;
        }
        .markdown-content strong {
            font-weight: 700;
        }
        .markdown-content code {
            background: rgba(0,0,0,0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .markdown-content p {
            margin-bottom: 0.75em;
        }
        .dark .markdown-content code {
            background: rgba(255,255,255,0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 dark:from-gray-900 dark:via-purple-900 dark:to-indigo-900 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header with Dark Mode Toggle -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 mb-8 text-center relative">
            <button id="themeToggle" class="absolute top-4 right-4 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                </svg>
                <svg id="moonIcon" class="w-6 h-6 text-indigo-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
            </button>

            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 mb-2">
                üéì FdP AutoCorrezione
            </h1>
            <p class="text-gray-600 dark:text-gray-300 text-lg">Universit√† di Pisa - Fondamenti di Programmazione</p>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 p-4 mb-6 rounded-lg">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-500 dark:text-blue-300 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">üìñ Come funziona</h4>
                    <ul class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                        <li>‚Ä¢ Parser ultra-robusto con threshold 80%</li>
                        <li>‚Ä¢ üõ°Ô∏è AddressSanitizer per rilevare errori di memoria</li>
                        <li>‚Ä¢ Analisi AI con suggerimenti personalizzati</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Form -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 mb-8" id="formCard">
            <form id="testForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìÖ Anno Esame</label>
                    <input type="number" id="anno" name="anno" value="2023" min="2020" max="2030" required
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-indigo-500 dark:focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800 transition">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìù Numero Appello</label>
                    <input type="number" id="appello" name="appello" value="2" min="1" max="10" required
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-indigo-500 dark:focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-800 transition">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìÅ File del Progetto</label>
                    <input type="file" id="files" name="files" multiple accept=".cpp,.h" required
                           class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-indigo-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 dark:file:bg-indigo-900 file:text-indigo-700 dark:file:text-indigo-200 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800 transition">
                    <div id="fileInfo" class="mt-2 text-sm text-gray-600 dark:text-gray-400 hidden"></div>
                </div>

                <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 dark:from-indigo-500 dark:to-purple-500 dark:hover:from-indigo-600 dark:hover:to-purple-600 text-white py-4 px-6 rounded-lg font-semibold text-lg transform hover:scale-105 transition shadow-lg">
                    üöÄ Avvia Correzione
                </button>
            </form>
        </div>

        <!-- Loading -->
        <div class="hidden" id="loading">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 dark:border-indigo-400 mb-4"></div>
                <p class="text-xl font-semibold text-gray-700 dark:text-gray-200">‚öôÔ∏è Elaborazione in corso...</p>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Download PDF, compilazione, esecuzione test...</p>
            </div>
        </div>

        <!-- Results -->
        <div class="hidden" id="results">
            <!-- Score Display -->
            <div id="scoreCard" class="rounded-2xl shadow-2xl p-12 mb-8 text-center text-white">
                <h2 id="scoreValue" class="text-7xl font-bold mb-4">--/30</h2>
                <p id="scoreText" class="text-2xl font-semibold">In attesa...</p>
            </div>

            <!-- New Test Button -->
            <div class="mb-8 text-center">
                <button id="newTestBtn" class="bg-white dark:bg-gray-800 text-indigo-600 dark:text-indigo-400 px-8 py-4 rounded-xl font-semibold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition border-2 border-indigo-600 dark:border-indigo-400">
                    üîÑ Nuova Prova
                </button>
            </div>

            <!-- ASan Errors Section (NEW!) -->
            <div id="asanSection" class="hidden mb-8">
                <div class="bg-gradient-to-r from-red-600 to-orange-600 dark:from-red-700 dark:to-orange-700 rounded-2xl shadow-2xl p-8">
                    <div class="flex items-center mb-4">
                        <span class="text-4xl mr-3">üõ°Ô∏è</span>
                        <h3 class="text-2xl font-bold text-white">AddressSanitizer - Errori di Memoria</h3>
                    </div>
                    <div id="asanContent" class="space-y-4"></div>
                </div>
            </div>

            <!-- AI Analysis Section -->
            <div id="aiSection" class="hidden mb-8">
                <div id="aiLoading" class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 rounded-2xl shadow-2xl p-8">
                    <div class="flex items-center mb-4">
                        <svg class="animate-spin h-6 w-6 text-white mr-3" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h3 class="text-2xl font-bold text-white">ü§ñ AI sta analizzando...</h3>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full h-3 overflow-hidden mb-3">
                        <div class="progress-bar bg-white h-full rounded-full"></div>
                    </div>
                    <p class="text-white text-opacity-90">Identificazione problemi e generazione suggerimenti...</p>
                </div>

                <div id="aiResult" class="hidden bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 rounded-2xl shadow-2xl p-8">
                    <div class="flex items-center mb-4">
                        <span class="text-4xl mr-3">ü§ñ</span>
                        <h3 class="text-2xl font-bold text-white">AI Overview</h3>
                    </div>
                    <div id="aiContent" class="markdown-content bg-white dark:bg-gray-800 bg-opacity-10 dark:bg-opacity-20 rounded-xl p-6 text-white leading-relaxed"></div>
                </div>

                <div id="aiError" class="hidden bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 rounded-lg">
                    <p class="text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è Analisi AI non disponibile</p>
                </div>
            </div>

            <!-- Parts Detail -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">üìä Dettaglio Valutazione</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="partsDetail"></div>
            </div>

            <!-- Warnings -->
            <div id="warningsSection"></div>

            <!-- Output -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">üíª Output Programma</h3>
                <pre id="outputText" class="bg-gray-900 dark:bg-black text-gray-100 dark:text-gray-300 p-6 rounded-xl overflow-x-auto max-h-96 text-sm"></pre>
            </div>
        </div>
    </div>

    <footer class="text-center text-white py-8 mt-8">
        <p class="text-lg font-semibold">üéì Universit√† di Pisa</p>
        <p class="text-sm mt-1 opacity-75">Dipartimento di Ingegneria dell'Informazione | v7.1 ¬© 2026</p>
    </footer>

    <script>
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        const savedTheme = localStorage.getItem('theme') || 'light';
        html.classList.remove('light', 'dark');
        html.classList.add(savedTheme);
        updateThemeIcons();

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.classList.remove(currentTheme);
            html.classList.add(newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcons();
        });

        function updateThemeIcons() {
            if (html.classList.contains('dark')) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        const form = document.getElementById('testForm');
        const filesInput = document.getElementById('files');
        const fileInfo = document.getElementById('fileInfo');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const formCard = document.getElementById('formCard');
        const submitBtn = document.getElementById('submitBtn');
        const newTestBtn = document.getElementById('newTestBtn');

        newTestBtn.addEventListener('click', () => {
            results.classList.add('hidden');
            formCard.style.display = 'block';
            form.reset();
            fileInfo.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        filesInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                fileInfo.classList.remove('hidden');
                fileInfo.innerHTML = `<strong>File selezionati:</strong><br>${files.map(f => `‚Ä¢ ${f.name}`).join('<br>')}`;
            } else {
                fileInfo.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);

            formCard.style.display = 'none';
            results.classList.add('hidden');
            loading.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/test', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                    if (data.needs_ai) {
                        startAIAnalysis(data.test_id);
                    }
                } else {
                    alert('Errore: ' + (data.error || 'Errore sconosciuto'));
                    formCard.style.display = 'block';
                }
            } catch (error) {
                alert('Errore di connessione: ' + error.message);
                formCard.style.display = 'block';
            } finally {
                loading.classList.add('hidden');
                submitBtn.disabled = false;
            }
        });

        function displayResults(data) {
            const scoreCard = document.getElementById('scoreCard');
            const scoreValue = document.getElementById('scoreValue');
            const scoreText = document.getElementById('scoreText');

            scoreValue.textContent = data.voto_text;
            scoreText.textContent = data.passed ? '‚úÖ Test Superato' : '‚ùå Test Non Superato';

            if (data.voto >= 18) {
                scoreCard.className = 'bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl shadow-2xl p-12 mb-8 text-center text-white';
            } else {
                scoreCard.className = 'bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl shadow-2xl p-12 mb-8 text-center text-white';
            }

            // ASan Errors (NEW!)
            const asanSection = document.getElementById('asanSection');
            const asanContent = document.getElementById('asanContent');

            if (data.asan_errors && data.asan_errors.length > 0) {
                asanSection.classList.remove('hidden');
                let asanHtml = '';

                for (const error of data.asan_errors) {
                    asanHtml += `
                        <div class="bg-white dark:bg-gray-800 bg-opacity-20 rounded-xl p-4 mb-3">
                            <div class="flex items-start mb-2">
                                <span class="text-2xl mr-2">üö®</span>
                                <div class="flex-1">
                                    <h4 class="text-xl font-bold text-white mb-1">${error.type}</h4>
                                    <p class="text-white text-opacity-90 text-sm mb-2">${escapeHtml(error.message)}</p>
                                    ${error.stack_trace ? `
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-white text-opacity-75 text-sm hover:text-opacity-100">
                                                üìã Stack Trace (click per espandere)
                                            </summary>
                                            <pre class="mt-2 bg-black bg-opacity-30 p-3 rounded text-white text-xs overflow-x-auto">${escapeHtml(error.stack_trace)}</pre>
                                        </details>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                asanContent.innerHTML = asanHtml;
            } else {
                asanSection.classList.add('hidden');
            }

            // Parts
            const partsDetail = document.getElementById('partsDetail');
            const isDark = html.classList.contains('dark');
            let partsHtml = '';

            const statusColors = {
                'OK': isDark ? 'bg-green-900 border-green-500 text-green-200' : 'bg-green-50 border-green-500 text-green-800',
                'FAIL': isDark ? 'bg-red-900 border-red-500 text-red-200' : 'bg-red-50 border-red-500 text-red-800',
                'N/A': isDark ? 'bg-yellow-900 border-yellow-500 text-yellow-200' : 'bg-yellow-50 border-yellow-500 text-yellow-800'
            };

            const statusIcons = {'OK': '‚úÖ', 'FAIL': '‚ùå', 'N/A': '‚ö†Ô∏è'};

            for (const [parte, info] of Object.entries(data.parti)) {
                const colorClass = statusColors[info.status] || statusColors['N/A'];
                const icon = statusIcons[info.status] || '‚ö†Ô∏è';

                partsHtml += `
                    <div class="${colorClass} border-l-4 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-2">${icon} ${parte} PARTE</h4>
                        <p class="text-2xl font-semibold">Similarit√†: ${info.similarity}%</p>
                    </div>
                `;
            }
            partsDetail.innerHTML = partsHtml;

            // Warnings
            const warningsSection = document.getElementById('warningsSection');
            if (data.warning && data.warning.length > 0) {
                const warnBg = isDark ? 'bg-yellow-900' : 'bg-yellow-50';
                const warnText = isDark ? 'text-yellow-200' : 'text-yellow-800';
                const warnTextDark = isDark ? 'text-yellow-300' : 'text-yellow-900';

                warningsSection.innerHTML = `
                    <div class="${warnBg} border-l-4 border-yellow-500 rounded-xl p-6 mb-8">
                        <h3 class="text-xl font-bold ${warnText} mb-3">‚ö†Ô∏è Warning Compilazione (${data.warning.length})</h3>
                        <pre class="text-sm ${warnTextDark} bg-white dark:bg-gray-800 p-4 rounded-lg overflow-x-auto">${data.warning.join('\n')}</pre>
                    </div>
                `;
            } else {
                warningsSection.innerHTML = '';
            }

            // Output
            document.getElementById('outputText').textContent = data.output || 'Nessun output';

            results.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function startAIAnalysis(testId) {
            const aiSection = document.getElementById('aiSection');
            const aiLoading = document.getElementById('aiLoading');
            const aiResult = document.getElementById('aiResult');
            const aiError = document.getElementById('aiError');
            const aiContent = document.getElementById('aiContent');

            aiSection.classList.remove('hidden');
            aiLoading.classList.remove('hidden');
            aiResult.classList.add('hidden');
            aiError.classList.add('hidden');

            try {
                const response = await fetch(`/api/ai-analysis/${testId}`);
                const data = await response.json();

                aiLoading.classList.add('hidden');

                if (data.success && data.analysis) {
                    aiContent.innerHTML = marked.parse(data.analysis);
                    aiResult.classList.remove('hidden');
                } else {
                    aiError.classList.remove('hidden');
                    aiError.querySelector('p').textContent = `‚ö†Ô∏è ${data.message || 'Analisi non disponibile'}`;
                }
            } catch (error) {
                aiLoading.classList.add('hidden');
                aiError.classList.remove('hidden');
                aiError.querySelector('p').textContent = `‚ö†Ô∏è Errore: ${error.message}`;
            }
        }
    </script>
</body>
</html>
